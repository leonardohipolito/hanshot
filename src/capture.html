<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hanshot</title>
  <link rel="stylesheet" href="../node_modules/cropperjs/dist/cropper.css">
  <style>

    html, body {
      padding: 0;
      margin: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    body.no-cursor {
      cursor: none !important;
    }

    video {
      display: none;
    }

    canvas {
      display: none;
      /*width: 100%;*/
      /*height: 100%;*/
    }

    img {
      width: 100%;
      height: 100%;
    }

  </style>
</head>
<body>

  <video autoplay></video>
  <canvas width="1920" height="1080"></canvas>

  <script type="text/javascript">

    'use strict';

    const KEY_ESC = 27;
    const KEY_ENTER = 13;


    const electron = require('electron');
    const Cropper = require('cropperjs');
    const desktopCapturer = electron.desktopCapturer;
    const ipcRenderer = electron.ipcRenderer;

    var video = document.querySelector('video');
    var canvas = document.querySelector('canvas');
    // var image = document.querySelector('img');


    var ctx = canvas.getContext('2d');
    var loadedStream = null;
    var cropper = null;

    document.addEventListener('keyup', function (event) {

      if (event.keyCode === KEY_ESC) {
        ipcRenderer.send('snapshot-cancelled');
        return;
      }

    }, true);

    ipcRenderer.on('snapshot-window-hidden', function (event, options) {
      if (!loadedStream) {
        console.log('Stream not loaded');
        return;
      }

      console.log(options);

      if (options.type === 'desktop') {

        ctx.drawImage(video, 0, 0);
        var dataURL = canvas.toDataURL('image/png');
        ipcRenderer.send('snapshot-shot', {
          dataURL: dataURL
        });

      } else if (options.type === 'selection') {

        cropper = new Cropper(canvas, {
          background: false,
          autoCrop: false
        });

        function keyup(event) {

          if (event.keyCode === KEY_ENTER) {

            var coords = cropper.getCropBoxData();

            document.querySelector('.cropper-container').style.visibility = 'hidden';
            document.body.classList.add('no-cursor');

            setTimeout(function () {
              ctx.drawImage(video, 0, 0);

              var data = canvas.toDataURL('image/png');

              cropper.image.src = canvas.toDataURL('image/png');
              cropper.image.onload = function () {

                console.log('loaded');

                // cropper.setCropBoxData(coords);
                var croppedCanvas = cropper.getCroppedCanvas();
                var dataURL = croppedCanvas.toDataURL('image/png');

                ipcRenderer.send('snapshot-shot', {
                  dataURL: dataURL
                });

                cropper.destroy();
                cropper = null;

              };


            }, 100);

            document.removeEventListener('keyup', keyup);

            return;
          }

        }

        document.addEventListener('keyup', keyup, true);


      } else {
        console.log('Unknown screenshot type');
      }
    });

    desktopCapturer.getSources({ types: ['window', 'screen'] }, function (error, sources) {

      if (error) throw error;

      for (let i = 0; i < sources.length; ++i) {

        // TODO: pick screens
        // TODO: multiple screens
        if (sources[i].id == 'screen:0:0') {
          navigator.webkitGetUserMedia({
            audio: false,
            video: {
              mandatory: {
                chromeMediaSource: 'desktop',
                chromeMediaSourceId: sources[i].id,
                // TODO: dynamic
                minWidth: 1920,
                maxWidth: 1920,
                minHeight: 1080,
                maxHeight: 1080
              }
            }
          }, gotStream, getUserMediaError);
        }

      }

    });

    function gotStream(stream) {
      video.src = URL.createObjectURL(stream);
      video.addEventListener('loadeddata', function () {
        loadedStream = stream;
      }, false);
    }

    function getUserMediaError(e) {
      console.log('err', e);
    }

  </script>
</body>
</html>
