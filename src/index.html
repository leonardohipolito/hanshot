<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hanshot</title>
</head>
<body>

  <button data-desktop>Dekstop</button>

  <hr>

  <video autoplay style="display: none"></video>
  <canvas width="1920" height="1080"></canvas>

  <script type="text/javascript">

    'use strict';

    const electron = require('electron');

    const remote = electron.remote;
    const desktopCapturer = electron.desktopCapturer;
    const ipcRenderer = electron.ipcRenderer;


    var video = document.querySelector('video');
    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');
    var loadedStream = null;

    var btnDesktop = document.querySelector('[data-desktop]');

    btnDesktop.addEventListener('click', function () {
      ipcRenderer.send('snapshot-initiated');
    }, false);

    ipcRenderer.on('snapshot-window-hidden', function () {
      ctx.drawImage(video, 0, 0);
      var dataURL = canvas.toDataURL('image/png');
      ipcRenderer.send('snapshot-shot', dataURL);
    });

    desktopCapturer.getSources({ types: ['window', 'screen'] }, function (error, sources) {

      if (error) throw error;

      for (let i = 0; i < sources.length; ++i) {

        // TODO: pick screens
        // TODO: multiple screens
        if (sources[i].id == 'screen:0:0') {
          navigator.webkitGetUserMedia({
            audio: false,
            video: {
              mandatory: {
                chromeMediaSource: 'desktop',
                chromeMediaSourceId: sources[i].id,
                // TODO: dynamic
                minWidth: 1920,
                maxWidth: 1920,
                minHeight: 1080,
                maxHeight: 1080
              }
            }
          }, gotStream, getUserMediaError);
        }

      }

    });

    function gotStream(stream) {
      video.src = URL.createObjectURL(stream);
      video.addEventListener('loadeddata', function () {
        loadedStream = stream;
      }, false);
    }

    function getUserMediaError(e) {
      console.log('err', e);
    }

  </script>
</body>
</html>