<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hanshot</title>
  <link rel="stylesheet" href="../../../node_modules/cropperjs/dist/cropper.css">
  <style>

    html, body {
      padding: 0;
      margin: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    body.no-cursor {
      cursor: none !important;
    }

    video {
      display: none;
    }

    canvas {
      display: none;
    }

  </style>
</head>
<body>

  <video autoplay></video>
  <canvas></canvas>

  <script type="text/javascript">

    'use strict';

    const KEY_ESC = 27;
    const KEY_ENTER = 13;

    const electron = require('electron');
    const Cropper = require('cropperjs');
    const desktopCapturer = electron.desktopCapturer;
    const ipcRenderer = electron.ipcRenderer;

    var video = document.querySelector('video');
    var canvas = document.querySelector('canvas');

    var ctx = canvas.getContext('2d');
    var loadedStream = null;

    document.addEventListener('keyup', function (event) {
      if (event.keyCode === KEY_ESC) {
        ipcRenderer.send('capture', { action: 'cancel' });
        return;
      }
    }, true);

    ipcRenderer.on('snapshot-window-hidden', function (event, options) {

      canvas.width = options.displayBounds.width;
      canvas.height = options.displayBounds.height;

      if (options.type === 'desktop') {
        screenshotDesktop(options);
      } else if (options.type === 'selection') {
        screenshotSelection(options);
      } else if (options.type === 'window') {
        screenshotWindow(options);
      } else {
        console.log('Unknown screenshot type');
      }
    });

    ipcRenderer.on('windows-requested', function (event) {
      desktopCapturer.getSources({ types: ['window', 'screen'] }, function (err, sources) {
        if (err) throw err;

        var windows = sources.map(function (source) {
          return {
            id: source.id,
            name: source.name
          };
        });

        event.sender.send('windows-loaded', windows);
      });
    });

    function setupStream(options, callback) {
      var windowId = options.windowId || 'screen:0:0';

      desktopCapturer.getSources(
        { types: ['window', 'screen'] },
        function (err, sources) {

          // debugger;

        if (err) throw err;

        for (let i = 0; i < sources.length; ++i) {

          // TODO: pick screens
          // TODO: multiple screens
          if (sources[i].id == windowId) {
            navigator.webkitGetUserMedia({
              audio: false,
              video: {
                mandatory: {
                  chromeMediaSource: 'desktop',
                  chromeMediaSourceId: sources[i].id,
                  // TODO: dynamic
                  // minWidth: 1920,
                  maxWidth: options.overallBounds.width,
                  // minHeight: 1080,
                  maxHeight: options.overallBounds.height
                }
              }
            }, function (stream) {
              video.src = URL.createObjectURL(stream);
              video.addEventListener('loadeddata', function onLoadedData() {
                loadedStream = stream;
                callback(null, stream);
                video.removeEventListener('loadeddata', onLoadedData);
              }, false);
            }, function (err) {
              console.log('err', err);
              callback(err);
            });
          }

        }

      });
    }

    function destroyStream() {
      loadedStream = null;
      // http://stackoverflow.com/a/28060352/1573638
      video.pause();
      video.src = '';
      video.load();
    }

    function screenshotDesktop(options) {

      setupStream(options, function (err, stream) {

        ctx.drawImage(video, -options.displayBounds.x, -options.displayBounds.y);

        var dataURL = canvas.toDataURL('image/png');
        ipcRenderer.send('capture', {
          action: 'complete',
          dataURL: dataURL,
          options: options
        });

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        destroyStream();

      });

    }

    function screenshotSelection(options) {
      var cropper = new Cropper(canvas, {
        background: false,
        autoCrop: false
      });

      function onEnter(event) {
        if (event.keyCode !== KEY_ENTER) {
          return true;
        }

        document.querySelector('.cropper-container').style.visibility = 'hidden';
        document.body.classList.add('no-cursor');

        setupStream(options, function (err, stream) {

          ctx.drawImage(video, -options.displayBounds.x, -options.displayBounds.y);

          var desktopDataURL = canvas.toDataURL('image/png');

          cropper.image.onload = function () {
            var croppedCanvas = cropper.getCroppedCanvas();
            var croppedDataURL = croppedCanvas.toDataURL('image/png');

            ipcRenderer.send('capture', {
              action: 'complete',
              dataURL: croppedDataURL,
              options: options
            });

            cropper.destroy();
            cropper = null;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            destroyStream();
          };

          cropper.image.src = desktopDataURL;

        });

        document.removeEventListener('keyup', onEnter);

        return;
      }

      document.addEventListener('keyup', onEnter, true);
    }

    function screenshotWindow(options) {

      setupStream(options, function (err, stream) {

        ctx.drawImage(video, 0, 0);

        var croppedCanvas = autocropRightBottomAlpha(canvas);

        var dataURL = croppedCanvas.toDataURL('image/png');
        ipcRenderer.send('capture', {
          action: 'complete',
          dataURL: dataURL,
          options: options
        });

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        destroyStream();
      });

    }

    // Based on https://gist.github.com/remy/784508
    function autocropRightBottomAlpha(canvas) {

      var ctx = canvas.getContext('2d');
      var copy = document.createElement('canvas').getContext('2d');
      var pixels = ctx.getImageData(0, 0, canvas.width, canvas.height);

      var cropX = 0, cropY = 0;

      for (var i = 0; i < pixels.data.length; i += 4) {
        var alpha = pixels.data[i+3];
        if (alpha !== 0) {

          // ?
          var x = (i / 4) % canvas.width;
          var y = ~~((i / 4) / canvas.width);

          cropX = Math.max(cropX, x);
          cropY = Math.max(cropY, y);
        }
      }

      if (!(cropX > 0 && cropY > 0)) {
        return canvas;
      }

      var cropped = ctx.getImageData(0, 0, cropX, cropY);

      copy.canvas.width = cropX;
      copy.canvas.height = cropY;
      copy.putImageData(cropped, 0, 0);

      return copy.canvas;
    }

  </script>
</body>
</html>
